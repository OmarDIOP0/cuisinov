@inject IHttpContextAccessor Accessor
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Mon Profil";

    bool isAdmin = Convert.ToBoolean(Accessor.HttpContext?.Session.GetString("IsAdmin") ?? "false");
    bool isGerant = Convert.ToBoolean(Accessor.HttpContext?.Session.GetString("IsGerant") ?? "false");
    string username = Accessor.HttpContext?.Session.GetString("Username") ?? "";
}

@section Styles {
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/createCategorie.css" />
    <link rel="stylesheet" href="~/css/profil.css" />
}

<section class="create-section">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="create-card">
                    <!-- Header -->
                    <div class="card-header">
                        <h2><i class="fas fa-user-circle me-2"></i>Mon Profil</h2>
                        <div class="subtitle">Gérez vos informations personnelles et votre mot de passe</div>
                    </div>

                    <div class="row g-0">
                        <!-- Form Section -->
                        <div class="col-lg-12">
                            <div class="form-container">
                                <!-- Profile Info Header -->
                                <div class="profile-header text-center mb-4">
                                    <div class="profile-avatar mb-3">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <h3 id="profileUsername" class="h4 mb-2">@username</h3>
                                    <div id="profileRole" class="profile-role">
                                        Chargement...
                                    </div>
                                </div>

                                <!-- Tabs Navigation -->
                                <ul class="nav nav-tabs nav-tabs-custom mb-4" id="profileTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                            <i class="fas fa-user-edit me-2"></i>Informations Personnelles
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                            <i class="fas fa-lock me-2"></i>Mot de Passe
                                        </button>
                                    </li>
                                </ul>

                                <!-- Tabs Content -->
                                <div class="tab-content" id="profileTabsContent">
                                    <!-- Tab Informations Personnelles -->
                                    <div class="tab-pane fade show active" id="info" role="tabpanel">
                                        <form id="profileForm">
                                            <input type="hidden" id="userId" name="Id" />

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label" for="login">
                                                            <i class="fas fa-at"></i>Nom d'utilisateur
                                                        </label>
                                                        <input type="text"
                                                               class="form-control"
                                                               id="login"
                                                               name="Login"
                                                               placeholder="Ex: john.doe, marie.dupont..."
                                                               required>
                                                        <small class="form-text text-muted mt-2">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Votre identifiant de connexion unique
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label" for="telephone">
                                                            <i class="fas fa-phone"></i>Téléphone
                                                        </label>
                                                        <input type="tel"
                                                               class="form-control"
                                                               id="telephone"
                                                               name="Telephone"
                                                               placeholder="+33 1 23 45 67 89"
                                                               required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label" for="email">
                                                            <i class="fas fa-envelope"></i>Email
                                                        </label>
                                                        <input type="email"
                                                               class="form-control"
                                                               id="email"
                                                               name="Email"
                                                               placeholder="votre@email.com">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="entrepriseDisplay">Entreprise</label>
                                                        <input type="text" id="entrepriseDisplay" class="form-control" disabled>
                                                        <input type="hidden" id="entrepriseId" name="EntrepriseId">
                                                    </div>

                                                </div>

                                            </div>

                                            <div class="btn-group">
                                                <button class="btn-back" type="button" id="btnCancelProfile">
                                                    <i class="fas fa-times me-2"></i>Annuler
                                                </button>
                                                <button class="btn-custom"
                                                        id="btnSaveProfile"
                                                        type="button"
                                                        data-url="/User/UpdateProfileUser">
                                                    <i class="fas fa-save me-2"></i>Enregistrer les modifications
                                                </button>
                                                @* <button class="btn-custom"
                                                        id="btnCreate"
                                                        type="button"
                                                        data-redirectroute="/Home/Profil"
                                                        data-url="/User/UpdateProfileUser">
                                                    <i class="fas fa-save me-2"></i>Save
                                                </button> *@
                                            </div>
                                        </form>
                                    </div>

                                    <!-- Tab Mot de Passe -->
                                    <div class="tab-pane fade" id="password" role="tabpanel">
                                        <form id="passwordForm">
                                            <div class="form-group">
                                                <label class="form-label" for="oldPassword">
                                                    <i class="fas fa-lock"></i>Ancien mot de passe
                                                </label>
                                                <div class="input-group">
                                                    <input type="password"
                                                           class="form-control"
                                                           id="oldPassword"
                                                           name="OldPassword"
                                                           placeholder="Saisissez votre ancien mot de passe"
                                                           required>
                                                    <button type="button" class="btn btn-outline-secondary password-toggle" data-target="oldPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label" for="newPassword">
                                                    <i class="fas fa-key"></i>Nouveau mot de passe
                                                </label>
                                                <div class="input-group">
                                                    <input type="password"
                                                           class="form-control"
                                                           id="newPassword"
                                                           name="NewPassword"
                                                           placeholder="Saisissez votre nouveau mot de passe"
                                                           required>
                                                    <button type="button" class="btn btn-outline-secondary password-toggle" data-target="newPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted mt-2">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Minimum 8 caractères avec chiffres et lettres
                                                </small>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label" for="confirmPassword">
                                                    <i class="fas fa-check-double"></i>Confirmer le mot de passe
                                                </label>
                                                <div class="input-group">
                                                    <input type="password"
                                                           class="form-control"
                                                           id="confirmPassword"
                                                           name="ConfirmPassword"
                                                           placeholder="Confirmez votre nouveau mot de passe"
                                                           required>
                                                    <button type="button" class="btn btn-outline-secondary password-toggle" data-target="confirmPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="btn-group">
                                                <button class="btn-back" type="button" id="btnCancelPassword">
                                                    <i class="fas fa-times me-2"></i>Annuler
                                                </button>
                                                <button class="btn-custom"
                                                        id="btnChangePassword"
                                                        type="button"
                                                        data-url="/Home/ResetPassword">
                                                    <i class="fas fa-key me-2"></i>Changer le mot de passe
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    

    <script>
        $(document).ready(function () {
            loadUserProfile();

            // Gestionnaire de basculement de visibilité des mots de passe
            $('.password-toggle').click(function() {
                const target = $(this).data('target');
                const input = $('#' + target);
                const icon = $(this).find('i');

                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Sauvegarde du profil
            $('#btnSaveProfile').click(function() {

                const formData = {
                    Id:parseInt($('#userId').val()),
                    Login: $('#login').val(),
                    Email: $('#email').val(),
                    Telephone: $('#telephone').val()?.trim(),
                    EntrepriseId:$('#entrepriseId').val()
                };

                console.log('Envoi des données profil:', formData);

                if (!formData.Login || !formData.Telephone) {
                    ToastR("Veuillez remplir tous les champs obligatoires", "error", 15);
                    return;
                }

                $.ajax({
                    url: $(this).data('url'),
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Réponse sauvegarde profil:', response);
                        if (response.success) {
                            ToastR(response.message, "success", 15);
                            $('#profileUsername').text(formData.Login);
                        } else {
                            ToastR(response.message, "error", 15);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur sauvegarde profil:', error);
                        ToastR("Erreur lors de la modification du profil", "error", 15);
                    }
                });
            });

            // Changement de mot de passe
            $('#btnChangePassword').click(function() {
                const formData = {
                    Id: $('#userId').val(),
                    Login: $('#login').val(),
                    OldPassword: $('#oldPassword').val(),
                    NewPassword: $('#newPassword').val(),
                    ConfirmPassword: $('#confirmPassword').val()
                };

                // Validation côté client
                if (!formData.OldPassword) {
                    ToastR("Veuillez saisir votre ancien mot de passe", "error", 15);
                    return;
                }
                if (!formData.NewPassword || formData.NewPassword.length < 8) {
                    ToastR("Le nouveau mot de passe doit contenir au moins 8 caractères", "error", 15);
                    return;
                }
                if (formData.NewPassword !== formData.ConfirmPassword) {
                    ToastR("Les mots de passe ne correspondent pas", "error", 15);
                    return;
                }

                $.ajax({
                    url: '/Home/ResetPassword',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Réponse complète:', response);

                        if (response.success) {
                            ToastR("Mot de passe changé avec succès", "success", 15);
                            $('#passwordForm')[0].reset();
                        } else {
                            if (response.errors) {
                                let errorMessages = [];
                                for (const field in response.errors) {
                                    errorMessages.push(...response.errors[field]);
                                }
                                ToastR(errorMessages.join('. '), "error", 15);
                            } else {
                                ToastR(response.message || "Erreur inconnue", "error", 15);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur technique:', error);
                        ToastR("Erreur technique lors du changement de mot de passe", "error", 15);
                    }
                });
            });

            // Boutons d'annulation
            $('#btnCancelProfile').click(function() {
                loadUserProfile();
            });

            $('#btnCancelPassword').click(function() {
                $('#passwordForm')[0].reset();
            });
        });

        function loadUserProfile() {
            console.log('loadUserProfile appelée');

            // Afficher un indicateur de chargement
            $('#profileRole').text('Chargement...');
            $('#login').val('Chargement...');
            $('#telephone').val('Chargement...');
            $('#email').val('Chargement...');

            $.ajax({
                url: '/User/GetCurrentUser',
                type: 'GET',
                success: function(response) {

                    if (response && response.success && response.data) {
                        const user = response.data;

                        // Remplir le formulaire de profil
                        $('#userId').val(user.id);
                        $('#login').val(user.login || '');
                        $('#telephone').val(user.telephone || '');
                        $('#email').val(user.email || '');
                        // $('#entrepriseId').val(user.entreprise.nom || 'Non spécifié');
                        if (user.entreprise) {
                $('#entrepriseDisplay').val(user.entreprise.nom);
                $('#entrepriseId').val(user.entreprise.id); // <--- l'ID est bien dans le hidden
            }

                        // Mettre à jour l'affichage du profil
                        $('#profileUsername').text(user.login || 'Utilisateur');

                        // Mettre à jour le badge du rôle
                        const roleBadge = $('#profileRole');
                        roleBadge.removeClass('role-admin role-gerant role-user');

                        if (user.profile === 'ADMIN') {
                            roleBadge.addClass('role-admin').text('ADMINISTRATEUR');
                        } else if (user.profile === 'GERANT') {
                            roleBadge.addClass('role-gerant').text('GÉRANT');
                        } else {
                            roleBadge.addClass('role-user').text('UTILISATEUR');
                        }

                        console.log('Profil chargé avec succès');
                    } else {
                        console.error('Structure de réponse invalide:', response);
                        ToastR("Erreur lors du chargement du profil", "error", 15);
                        $('#profileRole').text('Erreur');
                    }
                },
                error: function(xhr, status, error) {
                    ToastR("Erreur réseau lors du chargement du profil", "error", 15);
                    $('#profileRole').text('Erreur de chargement');
                }
            });
        }
    </script>
}