@inject IHttpContextAccessor Accessor
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Mon Profil";

    bool isAdmin = Convert.ToBoolean(Accessor.HttpContext?.Session.GetString("IsAdmin") ?? "false");
    bool isGerant = Convert.ToBoolean(Accessor.HttpContext?.Session.GetString("IsGerant") ?? "false");
    string username = Accessor.HttpContext?.Session.GetString("Username") ?? "";
}

@section Styles {
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/createCategorie.css" />
    <link rel="stylesheet" href="~/css/profil.css" />
}

<section class="profile-section">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="profile-card">
                    <!-- Header -->
                    <div class="card-header">
                        <h2><i class="fas fa-user-circle me-2"></i>Mon Profil</h2>
                        <div class="subtitle">Gérez vos informations personnelles et votre mot de passe</div>
                    </div>

                    <div class="row g-0">
                        <div class="col-lg-12">
                            <!-- Profile Info Header -->
                            <div class="profile-header">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-info">
                                    <h3 id="profileUsername" class="h4 mb-2">@username</h3>
                                    <div id="profileRole" class="profile-role role-user">
                                        Chargement...
                                    </div>
                                </div>
                            </div>

                            <!-- Tabs Navigation -->
                            <ul class="nav nav-tabs nav-tabs-custom" id="profileTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                        <i class="fas fa-user-edit me-2"></i>Informations Personnelles
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                        <i class="fas fa-lock me-2"></i>Mot de Passe
                                    </button>
                                </li>
                            </ul>

                            <!-- Tabs Content -->
                            <div class="tab-content tab-content-custom" id="profileTabsContent">
                                <!-- Tab Informations Personnelles -->
                                <div class="tab-pane fade show active" id="info" role="tabpanel">
                                    <form id="profileForm">
                                        <input type="hidden" id="userId" name="Id" />

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label" for="login">
                                                        <i class="fas fa-at"></i>Nom d'utilisateur
                                                    </label>
                                                    <input type="text"
                                                           class="form-control"
                                                           id="login"
                                                           name="Login"
                                                           placeholder="Ex: john.doe, marie.dupont..."
                                                           required>
                                                    <small class="form-text text-muted mt-2">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Votre identifiant de connexion unique
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label" for="telephone">
                                                        <i class="fas fa-phone"></i>Téléphone
                                                    </label>
                                                    <input type="tel"
                                                           class="form-control"
                                                           id="telephone"
                                                           name="Telephone"
                                                           placeholder="+33 1 23 45 67 89"
                                                           required>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label" for="email">
                                                        <i class="fas fa-envelope"></i>Email
                                                    </label>
                                                    <input type="email"
                                                           class="form-control"
                                                           id="email"
                                                           name="Email"
                                                           placeholder="votre@email.com">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label" for="entreprise">
                                                        <i class="fas fa-building"></i>Entreprise
                                                    </label>
                                                    <input type="text"
                                                           class="form-control readonly-field"
                                                           id="entreprise"
                                                           name="Entreprise"
                                                           readonly>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="btn-group">
                                            <button class="btn-back" type="button" id="btnCancelProfile">
                                                <i class="fas fa-times me-2"></i>Annuler
                                            </button>
                                            <button class="btn-custom"
                                                    id="btnSaveProfile"
                                                    type="button"
                                                    data-url="/User/UpdateUser">
                                                <i class="fas fa-save me-2"></i>Enregistrer les modifications
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Tab Mot de Passe -->
                                <div class="tab-pane fade" id="password" role="tabpanel">
                                    <form id="passwordForm">
                                        <input type="hidden" id="pwdUserId" name="Id" />
                                        <input type="hidden" id="pwdLogin" name="Login" />

                                        <div class="form-group">
                                            <label class="form-label" for="oldPassword">
                                                <i class="fas fa-lock"></i>Ancien mot de passe
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control"
                                                       id="oldPassword"
                                                       name="OldPassword"
                                                       placeholder="Saisissez votre ancien mot de passe"
                                                       required>
                                                <button type="button" class="password-toggle" data-target="oldPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label" for="newPassword">
                                                <i class="fas fa-key"></i>Nouveau mot de passe
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control"
                                                       id="newPassword"
                                                       name="NewPassword"
                                                       placeholder="Saisissez votre nouveau mot de passe"
                                                       required>
                                                <button type="button" class="password-toggle" data-target="newPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <small class="form-text text-muted mt-2">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Minimum 8 caractères avec chiffres et lettres
                                            </small>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label" for="confirmPassword">
                                                <i class="fas fa-check-double"></i>Confirmer le mot de passe
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control"
                                                       id="confirmPassword"
                                                       name="ConfirmPassword"
                                                       placeholder="Confirmez votre nouveau mot de passe"
                                                       required>
                                                <button type="button" class="password-toggle" data-target="confirmPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="btn-group">
                                            <button class="btn-back" type="button" id="btnCancelPassword">
                                                <i class="fas fa-times me-2"></i>Annuler
                                            </button>
                                            <button class="btn-custom"
                                                    id="btnChangePassword"
                                                    type="button"
                                                    data-url="/Home/ResetPassword">
                                                <i class="fas fa-key me-2"></i>Changer le mot de passe
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            console.log('Document ready - Début du chargement du profil');
            loadUserProfile();

            // Gestionnaire de basculement de visibilité des mots de passe
            $('.password-toggle').click(function() {
                const target = $(this).data('target');
                const input = $('#' + target);
                const icon = $(this).find('i');

                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Validation du formulaire de profil
            $('#profileForm').validate({
                rules: {
                    Login: { required: true },
                    Telephone: { required: true }
                }
            });

            // Validation du formulaire de mot de passe
            $('#passwordForm').validate({
                rules: {
                    OldPassword: { required: true },
                    NewPassword: { required: true, minlength: 8 },
                    ConfirmPassword: {
                        required: true,
                        equalTo: "#newPassword"
                    }
                },
                messages: {
                    ConfirmPassword: {
                        equalTo: "Les mots de passe ne correspondent pas"
                    }
                }
            });

            // Sauvegarde du profil
            $('#btnSaveProfile').click(function() {
                if ($('#profileForm').valid()) {
                    const formData = {
                        Id: $('#userId').val(),
                        Login: $('#login').val(),
                        Email: $('#email').val(),
                        Telephone: $('#telephone').val()
                    };

                    console.log('Envoi des données profil:', formData);

                    ajaxManager('PUT', $(this).data('url'), formData,
                        function(response) {
                            console.log('Réponse sauvegarde profil:', response);
                            if (response.success) {
                                ToastR(response.message, "success", 15);
                                // Mettre à jour le nom d'utilisateur affiché
                                $('#profileUsername').text(formData.Login);
                            } else {
                                ToastR(response.message, "error", 15);
                            }
                        },
                        function(error) {
                            console.error('Erreur sauvegarde profil:', error);
                            ToastR("Erreur lors de la modification du profil", "error", 15);
                        }
                    );
                }
            });

            // Changement de mot de passe
                    $('#btnChangePassword').click(function() {
            if ($('#passwordForm').valid()) {
                const formData = {
                    Id: $('#pwdUserId').val(),
                    Login: $('#pwdLogin').val(),
                    OldPassword: $('#oldPassword').val(),
                    NewPassword: $('#newPassword').val(),
                    ConfirmPassword: $('#confirmPassword').val()
                };

                console.log('Envoi changement mot de passe:', formData);

                $.ajax({
                    url: '/Home/ResetPassword',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Réponse changement mot de passe:', response);
                        if (response.success) {
                            ToastR(response.message, "success", 15);
                            $('#passwordForm')[0].reset();
                            setTimeout(() => { window.location.href = '/User/SignIn'; }, 2000);
                        } else {
                            ToastR(response.message, "error", 15);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur changement mot de passe:', error);
                        ToastR("Erreur lors du changement de mot de passe", "error", 15);
                    }
                });
            }
        });


            // Boutons d'annulation
            $('#btnCancelProfile').click(function() {
                console.log('Annulation - Rechargement du profil');
                loadUserProfile();
            });

            $('#btnCancelPassword').click(function() {
                $('#passwordForm')[0].reset();
            });

            // Support de la touche Entrée
            $('#login').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#btnSaveProfile').click();
                }
            });
        });

               function loadUserProfile() {
            console.log('loadUserProfile appelée');

            // Afficher un indicateur de chargement
            $('#profileRole').text('Chargement...');
            $('#login').val('Chargement...');
            $('#telephone').val('Chargement...');
            $('#email').val('Chargement...');

            // Utiliser $.ajax directement au lieu de ajaxManager
            $.ajax({
                url: '/User/GetCurrentUser',
                type: 'GET',
                success: function(response) {
                    console.log('Réponse API reçue via $.ajax:', response);

                    if (response && response.success && response.data) {
                        const user = response.data;
                        console.log('Données utilisateur:', user);

                        // Remplir le formulaire de profil
                        $('#userId').val(user.id);
                        $('#login').val(user.login || '');
                        $('#telephone').val(user.telephone || '');
                        $('#email').val(user.email || '');
                        $('#entreprise').val(user.entreprise || 'Non spécifié');

                        // Remplir le formulaire de mot de passe
                        $('#pwdUserId').val(user.id);
                        $('#pwdLogin').val(user.login || '');

                        // Mettre à jour l'affichage du profil
                        $('#profileUsername').text(user.login || 'Utilisateur');

                        // Mettre à jour le badge du rôle
                        const roleBadge = $('#profileRole');
                        roleBadge.removeClass('role-admin role-gerant role-user');

                        if (user.profile === 'ADMIN') {
                            roleBadge.addClass('role-admin').text('ADMINISTRATEUR');
                        } else if (user.profile === 'GERANT') {
                            roleBadge.addClass('role-gerant').text('GÉRANT');
                        } else {
                            roleBadge.addClass('role-user').text('UTILISATEUR');
                        }

                        console.log('Profil chargé avec succès via $.ajax');
                    } else {
                        console.error('Structure de réponse invalide:', response);
                        ToastR("Erreur lors du chargement du profil: " + (response?.message || "Données non disponibles"), "error", 15);
                        $('#profileRole').text('Erreur');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erreur AJAX dans loadUserProfile:', error);
                    console.error('Status:', status);
                    console.error('XHR:', xhr);
                    ToastR("Erreur réseau lors du chargement du profil", "error", 15);
                    $('#profileRole').text('Erreur de chargement');
                }
            });
        }

        // Test direct pour debug
        function testDirectAPI() {
            console.log('Test direct de l API...');
            $.ajax({
                url: '/User/GetCurrentUser',
                type: 'GET',
                success: function(response) {
                    console.log('Test direct - Réponse:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Test direct - Erreur:', error);
                }
            });
        }

        // Lancer le test au chargement
        $(window).on('load', function() {
            console.log('Window loaded - test API');
            testDirectAPI();
        });
    </script>
}