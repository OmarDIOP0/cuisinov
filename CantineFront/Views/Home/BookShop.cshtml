@using AutoMapper;
@using CantineBack.Models
@using CantineFront.Helpers;
@using Newtonsoft.Json;
@inject IHttpContextAccessor Accessor
@inject IMapper mapper;
@{

    var articlesInCart = Accessor.HttpContext?.Session.GetListObjectFromSession<Article>("ArticlesCart") ?? new List<Article>();
    var emplacements = Accessor.HttpContext?.Session.GetListObjectFromSession<Emplacement>("Emplacements") ?? new List<Emplacement>();
    var paymentMethods = Accessor.HttpContext?.Session.GetListObjectFromSession<PaymentMethod>("PaymentMethods") ?? new List<PaymentMethod>();
    PaymentMethod cashPay = paymentMethods.FirstOrDefault(p => p.Code == "CASH");
    PaymentMethod wavePay = paymentMethods.FirstOrDefault(p => p.Code == "WAVE");
    PaymentMethod omPay = paymentMethods.FirstOrDefault(p => p.Code == "OM");
    IDictionary<int, int> articlePrixDict = new Dictionary<int, int>();
    IDictionary<int, string> articlesImages = new Dictionary<int, string>();
    var selectedArticles = articlesInCart.GroupBy(d => d.Id)
                              .Select(
                                  g =>
                                  {

                                      var a = new ArticleBooking
                                              {
                                                  Id = g.Key,
                                                  Quantite = g.Sum(s => 1),
                                              };
                                      a = mapper.Map<ArticleBooking>(g.First());
                                      a.Quantite = g.Sum(s => 1);
                                      articlePrixDict[a.Id] = a.PrixDeVente;
                                      articlesImages[a.Id] = a.Image;
                                      return a;
                                  }

                              ).ToList();
    int montantTotal = 0;
    if (selectedArticles != null)
    {
        foreach (var item in selectedArticles)
        {
            montantTotal += item.PrixDeVente * item.Quantite;
        }

    }
    var articlePrixDictJSON = JsonConvert.SerializeObject(articlePrixDict);
    var articleImagesJSON = JsonConvert.SerializeObject(articlesImages);
}
@section Styles{
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" crossorigin="anonymous">
    <link href="~/lib/bootstrap-fileinput/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />

<link rel="stylesheet" href="/css/shop.css"/>
}
<section class="modern-cart-section">
    <div class="container-fluid px-5">
        <form id="formBooking">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col-12">
                    <div class="cart-card">
                        <div class="row g-0">

                            <!-- LEFT PART - LISTE DES ARTICLES -->
                            <div class="col-lg-8">
                                <div class="p-5">

                                    <div class="cart-header d-flex justify-content-between align-items-center mb-4">
                                        <h6 class="text-white"><span id="selectedArticlesCount">@selectedArticles.Count</span> article(s)</h6>
                                    </div>

                                    @foreach (var item in selectedArticles)
                                    {
                                        <div class="cart-item" id="row_@item.Id">

                                            <div class="cart-item-content">

                                                <div class="item-image-container">
                                                    <img src="data:image/png;base64,@item.Image"
                                                         onerror="this.src='/images/default.png';"
                                                         class="item-image" id="imageArticle_@item.Id">
                                                </div>

                                                <div class="item-details">
                                                    <h6 class="text-muted">@item.Categorie?.Name</h6>
                                                    <h5>@item.Title</h5>
                                                </div>

                                                <div class="quantity-control">
                                                    <button class="quantity-btn" type="button"
                                                            onclick="this.parentNode.querySelector('input').stepDown();updateTotalPrice()">
                                                        <i class="fa fa-minus"></i>
                                                    </button>

                                                    <input id="quantite_@item.Id" min="0" name="Quantite"
                                                           value="@item.Quantite" type="number"
                                                           class="quantity-input" onchange="updateTotalPrice()">

                                                    <button class="quantity-btn" type="button"
                                                            onclick="this.parentNode.querySelector('input').stepUp();updateTotalPrice()">
                                                        <i class="fa fa-plus"></i>
                                                    </button>
                                                </div>

                                                <div class="price-section">
                                                    <span class="price-highlight">
                                                        <span id="prixTotal_@item.Id">
                                                            @(item.Quantite* item.PrixDeVente)
                                                        </span> XOF
                                                    </span>
                                                </div>

                                                <div>
                                                    <button class="delete-btn deleteArticleCart"
                                                            data-articleid="@item.Id">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </div>

                                            </div>
                                        </div>
                                    }

                                    <div class="mt-4">
                                        <label class="mb-2">Commentaire</label>
                                        <textarea class="comment-box w-100" name="Comment" id="Comment"></textarea>
                                    </div>

                                    <div class="pt-4">
                                        <a href="/Home/Menu" class="back-link">
                                            <i class="fa fa-arrow-left me-2"></i>Retour à la boutique
                                        </a>
                                    </div>

                                </div>
                            </div>

                            <!-- RIGHT PART - RESUME -->
                            <div class="col-lg-4">
                                <div class="summary-section">
                                    <div class="summary-content">

                                        <h3 class="fw-bold mb-4">Résumé</h3>

                                        <div class="summary-item mb-4">
                                            <label class="mb-2">Méthode de paiement</label>

                                            <!-- Radios NON modifiés -->
                                            <div class="radio-inputs">
                                                <label>
                                                    <input class="radio-input" type="radio" name="PaymentMethodId"
                                                           value="@(cashPay?.Id ?? 1)" checked
                                                           data-code="@(cashPay?.Code ?? "CASH")">
                                                    <span class="radio-tile">
                                                        <span class="radio-icon"><i class="fa fa-money"></i></span>
                                                        <span class="radio-label">CASH</span>
                                                    </span>
                                                </label>

                                                <label>
                                                    <input class="radio-input" type="radio" name="PaymentMethodId"
                                                           value="@(wavePay?.Id ?? 3)"
                                                           data-code="@(wavePay?.Code ?? "WAVE")">
                                                    <span class="radio-tile">
                                                        <span class="radio-icon">
                                                            <img src="~/images/wave.png" width="40" height="40" />
                                                        </span>
                                                        <span class="radio-label">WAVE</span>
                                                    </span>
                                                </label>

                                                <label>
                                                    <input class="radio-input" type="radio" name="PaymentMethodId"
                                                           value="@(omPay?.Id ?? 4)"
                                                           data-code="@(omPay?.Code ?? "OM")">
                                                    <span class="radio-tile">
                                                        <span class="radio-icon">
                                                            <img src="~/images/orangemoney.png" width="40" height="40" />
                                                        </span>
                                                        <span class="radio-label">OM</span>
                                                    </span>
                                                </label>
                                            </div>

                                            <div class="my-2" id="scanLoading" style="display:none">
                                                <div class="spinner-border"></div>
                                                Scannez votre QR CODE
                                            </div>
                                        </div>

                                        <hr>

                                        <div class="d-flex justify-content-between mb-4">
                                            <h5 class="text-uppercase">Prix Total</h5>
                                            <h5 class="total-amount" id="totalPrice">@montantTotal XOF</h5>
                                        </div>

                                        <button type="button" id="btnCommand"
                                                class="btn-confirm-command w-100">
                                            Soumettre la commande
                                        </button>

                                    </div>
                                </div>
                            </div>

                        </div> <!-- row -->
                    </div> <!-- cart-card -->
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        const CommandeADistance = false;
        let userSolde = 0;
        let setUserSolde = false;
        let checkSolde = true;


        $("#formBooking").validate({
            rules: {
                "EmplacementId": { required: true },
                "Quantite": { required: true, min: 1 },
            },
            messages: {
                "Quantite": { min: "La quantité doit être supérieure ou égale à 1." },
            },
            feedbackIcons: {
                valid: 'fa fa-check',
                invalid: 'fa fa-remove',
                validating: 'fa fa-refresh'
            },
            errorClass: "error fail-alert",
            validClass: "valid success-alert",
            errorPlacement: function (error, element) {
                var placement = $(element).data('error');
                if ($(element).attr("name") == "Quantite") {

                    error.insertAfter(element.closest("[id^='row_']"));
                }

                else if (placement) {

                    console.log(placement.classNames)
                    $(placement).append(error)
                } else {
                    error.insertAfter(element);
                }
            }
        })
        console.clear();
        const ARTICLES_PRIX_DICT = JSON.parse('@Html.Raw(articlePrixDictJSON)');
        var articleImages = JSON.parse('@Html.Raw(articleImagesJSON)');
        function updateTotalPrice(showMessage = true) {

            var totalPrice = 0;
            for (const [id, price] of Object.entries(ARTICLES_PRIX_DICT)) {
                var $quantite = $("#quantite_" + id)
                var q = $quantite.length > 0 ? $quantite.val() : 0
                totalPrice += q * price;
                $("#prixTotal_" + id).text(q * price);
            }

            $("#totalPrice").text(`${totalPrice} XOF`);
            return totalPrice;
        }

        $(function () {
            try {
                const ARTICLES_IDS = Object.keys(ARTICLES_PRIX_DICT)
                var len = ARTICLES_IDS.length
                loadImageSuccessHandler = (res) => {
                    if (res != null) {
                        var imageId = res.id
                        $(`#imageArticle_${imageId}`).attr("src", `data:image/png;base64,${res.image}`);
                    }

                }
                function doSetTimeout(i) {
                    var id = ARTICLES_IDS[i]
                    setTimeout(function () {
                        console.log("images = ", id)
                        ajaxManager('GET', '/Article/GetArticleImage?id=' + id, loadImageSuccessHandler, (err) => { });
                    }, 10);
                }

                for (var i = 0; i < len; i++) {

                    doSetTimeout(i);
                }
            }
            catch {
            }
            $("#PaymentMethodId").on("change", function () {

                checkSolde = $(this).find("option:selected").data("code") == "QRCODE";
                console.log("checkSolde = ", checkSolde)

                if (!checkSolde) {
                    $("#btnCommand").prop("disabled", false);
                    $("#solde").removeClass("text-warning text-danger text-success").addClass("text-success");
                    $("#messageSolde").text("");
                } else {
                    let montantTotal = updateTotalPrice(false);
                }
            });
            var getUserSuccessHandler = (res) => {
                if (res) {
                    if (res.success) {
                        $('#scanLoading').hide();
                        let user = res.data;
                        if (user) {
                            $("#userId").val(user.id);
                            $("#solde").text(`${user.solde} XOF`);
                            $("#soldeRestant").val(user.solde);
                            userSolde = user.solde;
                            setUserSolde = true;
                            $("#client").text(user.prenom + " " + user.nom);

                        } else {
                            ToastR("Utilisateur introuvable ", "error", 10, "toast-bottom-right");
                            return;
                        }
                        let montantTotal = updateTotalPrice(false);

                    } 
                    else {

                        ToastR("Utilisateur introuvable ", "error", 10, "toast-bottom-right");
                    }

                } else {
                    ToastR("Utilisateur introuvable ", "error", 10, "toast-bottom-right");
                }

            }
            $("#qrCode").on("change", function () {
              if(this.value){
                  if(this.value.length>24){
                        this.value = this.value.trim().substring(0, 24);
                        return;
                  }
              }

                if ($("#qrCodePay").is(":checked")){
                    setTimeout(function () {
                        let val = $("#qrCode").val();

                        if (val && typeof val === "string") {

                            if (val.length = 24) {
                                ajaxManager("GET", "/User/GetUserByQrCode", getUserSuccessHandler, errorHandler, { qrCode: val })
                            }
                        }
                    }, 1000);
                }
            });

            $(".deleteArticleCart").off("click").on("click", function () {
                var id = $(this).data("articleid")
                if (id > 0) {
                    var successHandler = (data) => {

                        if (data == undefined || data == null || data == "")
                            ToastR("Une erreur a été rencontrée", "error", 10);
                        else {

                            if (data.success) {
                                delete ARTICLES_PRIX_DICT[id]
                                $("#row_" + id).remove();
                                $("#line_" + id).remove();
                                $("#cartBadge").text(data.object);
                                $("#cartBadge").show();
                                $("#cartBadgeFloat").show();
                                $("#cartBadgeFloatClear").show();
                                $("#cartBadgeFloatCount").text(data.object)

                                updateTotalPrice();
                                console.log(ARTICLES_PRIX_DICT)
                                $("#selectedArticlesCount").text(Object.keys(ARTICLES_PRIX_DICT).length)
                            }
                            else {
                                ToastR(data.message, "error", 10);
                            }
                        }
                    };
                    var errorHandler = (err) => {

                        ToastR("La suppréssion a échoué", "error", 10);
                    };
                    ajaxManager("DELETE", "/Home/DeleteArticleCart", successHandler, errorHandler, { id: id })
                }
            }
            );
            $("#btnCommand").off().on("click", function (e) {
                var btn = $(this);
                if ($("#formBooking").valid()) {
                    btn.prop("disabled", true);
                    var postData = {

                        EmplacementId: $("#EmplacementId").val() || 5,
                        CommandeADistance: false,
                        PaymentMethodId: parseInt($("input[type='radio'][name='PaymentMethodId']:checked").val()),
                        PaymentMethodeCode: $("input[type='radio'][name='PaymentMethodId']:checked").data("code")
                    }
                    var lignesCommandes = [];
                    for (const [id, price] of Object.entries(ARTICLES_PRIX_DICT)) {

                        var $quantite = $("#quantite_" + id)
                        var q = $quantite.length > 0 ? $quantite.val() : 0;
                        lignesCommandes.push({
                                  ArticleId: parseInt(id),
                                  Quantite: parseInt(q),
                                  PrixTotal: parseInt(q) * price
                                })
                    }
                    if (lignesCommandes.length == 0) {
                        ToastR("Aucune ligne de commande n'est trouvée", "error", 5);
                        btn.prop("disabled", false);
                        return;
                    }
                    postData["LigneCommands"] = lignesCommandes;
                    console.log(postData);
                    postData["Comment"] = $.trim($("#Comment").val());
                    try {
                        var successHandler = (data) => {
                            endLoadingById("body");
                            if (data == undefined || data == null || data == "")
                                ToastR("Une erreur a été rencontrée", "error", 10);
                            else {

                                if (data.success) {
                                    if(isGerant || isAdmin){
                                        ToastR("Commande enregistrée avec succès!", "success", 10, "toast-bottom-right");
                                       
                                            setTimeout(() => { window.location = window.location.origin + "/Home/Menu"; }, 3000)
                                    }else{
                                        ToastR("Commande envoyée avec succès!", "success", 10, "toast-bottom-right");
                                        sendDataCommand("shop", JSON.stringify(data.object)).then(() => {
                                            setTimeout(() => { window.location = window.location.origin + "/Home/Menu"; }, 3000)
                                        });
                                    }
                                }
                                else {
                                    btn.prop("disabled", false);
                                    ToastR(data.message, "error", 10);
                                }
                            }
                        };
                        var errorHandler = (err) => {
                            btn.prop("disabled", false);
                            ToastR("Une erreur inattendue a été rencontrée", "error", 15);
                        }
                        setUserSolde = false;
                        userSolde = 0;
                        console.log("PostData",postData);
                        if (isGerant || isAdmin) {
                            ajaxManager("POST", "/Commande/CreateCommandeByPartner", successHandler, errorHandler, {...postData });
                        }else{
                            ajaxManager("POST", "/Commande/PostLocalCommande", successHandler, errorHandler, { QrCode: $("#qrCode").val(), ...postData });
                        }
                    } catch (e) {
                        console.log("Error : " + e);
                    }
                    finally {
                    }
                }
            });

            $("#cashPay, #qrCodePay, #wavePay, #omPay").change(function () {
                if ($("#cashPay").is(":checked") || $("#wavePay").is(":checked") || $("#omPay").is(":checked")) {
                    $('#scanLoading').hide();
                    $('#clientDiv').removeClass("d-flex").hide();
                    $('#soldeDiv').removeClass("d-flex").hide();
                    $("#messageSolde").text("").hide();
                    $("#qrCode").val("")
                }
                else if ($("#qrCodePay").is(":checked")) {
                    $('#scanLoading').show();
                    $('#clientDiv').addClass("d-flex").show();
                    $('#soldeDiv').addClass("d-flex").show();
                    $("#qrCode").focus()
                }
            });
        });
    </script>
                        }