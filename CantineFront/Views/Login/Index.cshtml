<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Cuisinov</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link  rel="stylesheet" href="/css/login.css"/>
    
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="logo-section floating-element">
                <div class="logo-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <h1 class="app-name">CUISINOV</h1>
                <p class="app-tagline">Votre restaurant d'entreprise</p>
            </div>

            <form id="formLogin">
                <!-- Login Section -->
                <div id="loginSection">
                    <div class="form-group">
                        <label class="form-label" for="username">Nom d'utilisateur</label>
                        <div class="input-group">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text"
                                   class="form-input"
                                   id="username"
                                   name="username"
                                   placeholder="Votre nom d'utilisateur"
                                   onkeyup="this.value = this.value.replace(/ /g, '')">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="password">Mot de passe</label>
                        <div class="input-group">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password"
                                   class="form-input"
                                   id="password"
                                   name="password"
                                   placeholder="Votre mot de passe">
                            <button type="button" class="password-toggle" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-login" id="btnSignIn">
                        Se Connecter
                    </button>
                </div>

                <!-- Reset Password Section -->
                <div id="resetSection" class="reset-section">
                    <div class="form-group">
                        <label class="form-label" for="oldPassword">Ancien mot de passe</label>
                        <div class="input-group">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-input" id="oldPassword" name="oldPassword" placeholder="Votre ancien mot de passe">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="newPassword">Nouveau mot de passe</label>
                        <div class="input-group">
                            <i class="fas fa-key input-icon"></i>
                            <input type="password" class="form-input" id="newPassword" name="newPassword" placeholder="Votre nouveau mot de passe">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirmation du mot de passe</label>
                        <div class="input-group">
                            <i class="fas fa-key input-icon"></i>
                            <input type="password" class="form-input" id="confirmPassword" name="confirmPassword" placeholder="Confirmez votre mot de passe">
                        </div>
                    </div>

                    <button type="submit" class="btn-login" id="btnResetPwd">
                        Modifier le mot de passe
                    </button>
                </div>
            </form>

            <div class="register-link">
                <p>Nouveau sur Cuisinov ? <a href="/Login/Register">Créer un compte</a></p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let Reset_Password = false;

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Fonction ToastR simulée (à remplacer par votre implémentation réelle)
        function ToastR(message, type, duration) {
            console.log(`${type.toUpperCase()}: ${message} (${duration}s)`);
            // Implémentez votre système de notifications toast ici
        }

        // Fonction ajaxManager simulée (à remplacer par votre implémentation réelle)
        function ajaxManager(method, url, successHandler, errorHandler, data) {
            console.log(`AJAX ${method}: ${url}`, data);
            // Simuler une réponse réussie pour les tests
            setTimeout(() => {
                if (url.includes('SignIn')) {
                    successHandler({
                        Success: true,
                        Message: "Connexion réussie",
                        ResetPassword: false
                    });
                } else if (url.includes('ResetPassword')) {
                    successHandler({
                        Success: true,
                        Message: "Mot de passe modifié avec succès"
                    });
                }
            }, 1000);
        }

        var errorHandler = function (err) {
            ToastR("Nom d'utilisateur ou mot de passe incorrect!", "error", 10);
        }

        const signInListener = event => {
            event.preventDefault();

            let username = $("#username").val()
            if (username == null || username.trim() == "") {
                ToastR("Le nom d'utilisateur est requis", "error", 15);
                return;
            }
            let password = $("#password").val()
            if (password == null || password.trim() == "") {
                ToastR("Le mot de passe est requis", "error", 15);
                return;
            }

            let successHanlder = function (res) {
                if (res != null) {
                    if (res.Success) {
                        ToastR(res.Message, "success", 10);
                        console.log("Reçu ", res);

                        if (res.ResetPassword) {
                            Reset_Password = true;
                            $("#loginSection").hide();
                            $("#resetSection").show();
                            $("#btnSignIn").hide();
                            $("#btnResetPwd").show();
                        } else {
                            location.href = location.origin + "/Home/Menu"
                        }

                    } else {
                        ToastR(res.message, "error", 10);
                    }
                } else {
                    ToastR("Erreur de connexion", "error", 10);
                }
            }

            try {
                if(Reset_Password){
                    var postData = {
                        Login: username,
                        OldPassword: $("#oldPassword").val(),
                        NewPassword: $("#newPassword").val(),
                        ConfirmPassword: $("#confirmPassword").val()
                    }
                    ajaxManager("POST", `/Login/ResetPassword`, successHanlder, errorHandler, postData);
                } else {
                    ajaxManager("POST", `/Login/SignIn?username=${username}&password=${password}`, successHanlder, errorHandler);
                }

            } catch (e) {
                console.error(e);
            }
        }

        const form = document.getElementById('formLogin');
        form.addEventListener('submit', signInListener);
    </script>
</body>
</html>