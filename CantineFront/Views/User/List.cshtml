@section Styles {
    <link rel="stylesheet" href="~/css/categorie.css" />
    <style>
        #tbUsers thead th {
            font-size: 0.8em !important;
        }

        /* Styles pour les profils */
        .badge-profile-admin {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .badge-profile-gerant {
            background: linear-gradient(135deg, #fd7e14, #e55a00);
            color: white;
        }

        .badge-profile-user {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            color: white;
        }

        .badge-status-active {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
        }

        .badge-status-inactive {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        /* Amélioration des boutons d'action */
        .btn-action {
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--accent-color), #20c997);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--danger-color), #e83e8c);
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Style pour le lien de réinitialisation */
        .link-primary {
            color: var(--primary-color) !important;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

            .link-primary:hover {
                color: var(--primary-dark) !important;
                text-decoration: underline;
            }
    </style>
}

<div class="container-fluid p-4">
    <!-- Header Section -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="h4 mb-0 text-primary">
                        <i class="fas fa-boxes me-2"></i>Gestion des Utilisateurs
                    </h2>
                    <p class="text-muted mb-0">Gérez les utilisateurs de votre restaurant d'entreprise</p>
                </div>
                <div class="col-md-6 text-end">
                    <a class="btn btn-primary btn-lg px-4" href="/User/Create">
                        <i class="fas fa-plus-circle me-2"></i>Nouvel Utilisateur
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- DataTable Card -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tbUsers" style="width:100%">
                    <thead class="table-light">
                        <tr>
                            <th scope="col"><input id="selectallCheckbox" type="checkbox" class="select-all" /></th>
                            <th scope="col">Login</th>
                            <th scope="col">Password</th>
                            @* <th scope="col">Email</th> *@
                            <th scope="col">Téléphone</th>
                            <th scope="col">Profil</th>
                            <th scope="col">Actif</th>
                            <th scope="col">Actions</th>
                            @* <th scope="col">Plus</th> *@
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by DataTable -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="text-muted mt-2">Chargement des Utilisateurs...</p>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript">
        $(function () {
            // Show loading spinner
            $('#loadingSpinner').show();

            var successHandler = function (res) {
                console.log(JSON.stringify(res));
                $('#loadingSpinner').hide();

                if (res) {
                    if (res.success) {
                        ToastR(res.message, res.status, 15);

                        $('#tbUsers').DataTable({
                            data: res.data,
                            responsive: true,
                            destroy: true,
                            language: {
                                "zeroRecords": "<div class='dataTables_empty'><i class='fas fa-inbox'></i><br>Aucun utilisateur trouvé</div>",
                                "emptyTable": "<div class='dataTables_empty'><i class='fas fa-inbox'></i><br>Aucune donnée disponible</div>",
                                "info": "Affichage de _START_ à _END_ sur _TOTAL_ Utilisateurs",
                                "infoEmpty": "Affichage de 0 à 0 sur 0 Users",
                                "infoFiltered": "(filtrées depuis _MAX_ Utilisateurs au total)",
                                "lengthMenu": "Afficher _MENU_ Users",
                                "search": "<i class='fas fa-search'></i>",
                                "paginate": {
                                    "first": "<i class='fas fa-angle-double-left'></i>",
                                    "last": "<i class='fas fa-angle-double-right'></i>",
                                    "next": "<i class='fas fa-angle-right'></i>",
                                    "previous": "<i class='fas fa-angle-left'></i>"
                                }
                            },
                            columns: [
                                {
                                    data: null,
                                    width: '1%',
                                    render: function (data, type, row, meta) {
                                        return '<span class="text-muted">' + (meta.row + 1) + '</span>';
                                    }
                                },
                                {
                                    width: '15%',
                                    data: 'login',
                                    defaultContent: '',
                                    className: "text-center"
                                },
                                {
                                    width: '15%',
                                    data: 'password',
                                    defaultContent: '',
                                    className: "tablesmalltext",
                                    render: function (data, type, row) {
                                        if (row.useActiveDirectoryAuth != true) {
                                            return `<a href="#" class="link-primary btn-toggle-menu" data-method="PATCH"
                                                    data-message="Voulez-vous réinitialiser le mot de passe?</b>"
                                                    data-url="/User/RenitializePassword/${row.id}" data-toggle="modal"
                                                    data-callback="false"
                                                    data-target="#confirmModal" rel="tooltip">Réinitialiser</a>`;
                                        }
                                        return '';
                                    }
                                },
                                // {
                                //     width: '10%',
                                //     data: 'email',
                                //     className: "text-center",
                                //     defaultContent: '',
                                // },
                                {
                                    width: '15%',
                                    data: 'telephone',
                                    defaultContent: '',
                                    className: "text-center",
                                },
                                {
                                    width: '10%',
                                    data: 'profile',
                                    defaultContent: '',
                                    className: "text-center",
                                    render: function (data, type, row) {
                                        var profileClass = '';
                                        switch(data?.toUpperCase()) {
                                            case 'ADMIN':
                                                profileClass = 'badge-profile-admin';
                                                break;
                                            case 'GERANT':
                                                profileClass = 'badge-profile-gerant';
                                                break;
                                            case 'USER':
                                                profileClass = 'badge-profile-user';
                                                break;
                                            default:
                                                profileClass = 'badge-profile-user';
                                        }
                                        return `<span class="badge ${profileClass}">${data}</span>`;
                                    }
                                },
                                {
                                    data: "actif",
                                    width: '5%',
                                    className: 'text-center',
                                    render: function (data, type, row) {
                                        var className = data ? "badge-status-active" : "badge-status-inactive";
                                        var status = data ? "actif" : "inactif";
                                        return `<span class="badge ${className}">${status}</span>`;
                                    }
                                },
                                {
                                    data: null,
                                    width: '30%',
                                    className: 'text-center',
                                    render: function (data, type, row) {
                                        var btnEdit = `<a class="btn btn-action btn-edit me-2" href="/User/Update/${row.id}" title="Modifier">
                                 <i class="fas fa-edit me-1"></i>Modifier
                               </a>`;
                                        var btnDelete = `<button type="button" class="btn btn-action btn-delete me-2"
                                    data-method="DELETE"
                                    data-message="Voulez-vous vraiment supprimer l'utilisateur <b>${row.login}</b>"
                                    data-url="/User/DeleteUser/${row.id}"
                                    data-toggle="modal"
                                    data-target="#confirmModal"
                                    rel="tooltip"
                                    title="Supprimer">
                                <i class="fas fa-trash me-1"></i>Supprimer
                             </button>`;
                                        var btnRecharger = "";
                                        if (row.profile != "GERANT") {
                                            btnRecharger = `
                                            <button type="button" data-method="PUT"
                                                        data-modaltitle="Rechargement compte"
                                                                data-successhandler="rechargementSuccessHandler"
                                                                data-errorhandler="errorHandler"
                                                                data-callback="updateSoldeCell"
                                                                data-forward="rechargeCompteFormValid()"
                                                        data-getdata="getDataSoldeForm(${row.id})"
                                                                                                    data-modalbody=" <h6>Recharger le compte de <b>${row.login} Tel: ${row.telephone} </b><br><br><input class='form-control' name='montant' id='montant' type='number' ></h6>"
                                                                    data-url="/User/RechargerCompte" data-toggle="modal"
                                                            data-target="#genericModal" rel="tooltip"
                                                    class="btn btn-success m-2 btn-sm" data-original-title="" title="">
                                                <span class="fa-money  fa"></span>
                                            </button>`;
                                        }

                                        return '<div class="d-flex justify-content-center">' + btnEdit + btnDelete + '</div>';
                                    }
                                },
                                // {
                                //     data: null,
                                //     width: '10%',
                                //     defaultContent: "",
                                //     className: "dt-custom-control custom px-2",
                                //     render: function (data, type, row, meta) {
                                //         if (type === 'export') {
                                //             return data;
                                //         }
                                //         return `<span class="dt-custom-control-plus"></span> <a></a>`;
                                //     }
                                // },
                            ],
                            initComplete: function () {
                                // Add custom styling after table initialization
                                $('.dataTables_filter label').addClass('d-flex align-items-center');
                                $('.dataTables_filter input').attr('placeholder', 'Rechercher un utilisateur...');
                            },
                            drawCallback: function (setting) {
                                // Re-initialize tooltips
                                $('[data-toggle="tooltip"]').tooltip();
                                $('[title]').tooltip();
                            }
                        });
                    } else {
                        ToastR(res.message, res.status, 15);
                    }
                }
            }

            var errorHandler = (err) => {
                $('#loadingSpinner').hide();
                ToastR("Une erreur a été rencontrée lors du chargement des Users", "error", 15);
                console.error(err);
            }

            ajaxManager('GET', '/User/GetUsers', successHandler, errorHandler);
        });

        var mouvementSuccessHandler = (res) => {
            if (res) {
                let status = res.success ? "success" : "error"
                ToastR(res.message, status, 15);
            }
        }
    </script>
}