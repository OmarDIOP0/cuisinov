@section Styles {
    <link href="~/css/starrating.css" rel="stylesheet" />
    <link href="~/datatables.net-buttons-bs/buttons.bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .buttons-pdf, .buttons-excel.buttons-html5 {
            background-color: #2c5aa0 !important;
            border-color: #2c5aa0 !important;
            margin-bottom: 10px;
            color: white !important;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
        }

            .buttons-pdf:hover, .buttons-excel.buttons-html5:hover {
                background-color: #1e3d6f !important;
                border-color: #1e3d6f !important;
            }

        /* Design compact et professionnel */
        .reports-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }

        .page-header {
            margin-bottom: 15px;
        }

        .page-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.5rem;
            margin: 0;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 2px;
        }

        /* Filtres compacts */
        .filter-section {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .filter-title {
            color: #495057;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .form-control {
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.85rem;
            padding: 6px 10px;
            height: 36px;
        }

            .form-control:focus {
                border-color: #2c5aa0;
                box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
            }

        .btn-primary {
            background-color: #2c5aa0;
            border-color: #2c5aa0;
            border-radius: 3px;
            padding: 6px 15px;
            font-weight: 500;
            font-size: 0.85rem;
            height: 36px;
        }

            .btn-primary:hover {
                background-color: #1e3d6f;
                border-color: #1e3d6f;
            }

        /* Statistiques compactes */
        .stats-section {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px 15px;
            text-align: center;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .stats-value {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Bouton rapport compact */
        .btn-report {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            border-radius: 3px;
            padding: 6px 12px;
            font-weight: 500;
            font-size: 0.85rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            height: 36px;
        }

            .btn-report:hover {
                background-color: #218838;
                border-color: #1e7e34;
                color: white;
                text-decoration: none;
            }

        /* Tableau compact */
        .table-container {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        #tbCommandes {
            width: 100% !important;
            margin: 0;
            font-size: 0.85rem;
        }

            #tbCommandes thead th {
                background-color: #f8f9fa;
                color: #495057;
                font-weight: 600;
                padding: 8px 12px;
                border-bottom: 1px solid #e9ecef;
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }

            #tbCommandes tbody td {
                padding: 8px 12px;
                border-bottom: 1px solid #f8f9fa;
                vertical-align: middle;
            }

            #tbCommandes tbody tr:hover {
                background-color: #f8f9fa;
            }

        /* Badges de statut compacts */
        .status-badge {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Réduction des espacements globaux */
        .container-fluid.py-4 {
            padding-top: 15px !important;
            padding-bottom: 15px !important;
        }

        .row {
            margin-bottom: 8px;
        }

        .mb-4 {
            margin-bottom: 12px !important;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .reports-container

        {
            padding: 12px;
        }

        .page-title {
            font-size: 1.3rem;
        }

        .filter-section {
            padding: 10px;
        }

        .stats-value {
            font-size: 1.1rem;
        }

        }
    </style>
}

<div class="container-fluid py-4">
    <div class="reports-container">
        <!-- En-tête compact -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h1 class="page-title">Rapports de Ventes</h1>
                    <div class="page-subtitle">Suivi et analyse des commandes</div>
                </div>
                <div class="col-md-4">
                    <div class="stats-section">
                        <div class="stats-label">Total des ventes livrées</div>
                        <div class="stats-value" id="totalMontantVente">0 FCFA</div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" data-method="POST"
                            data-target="#generateReportModal" data-toggle="modal" rel="tooltip"
                            class="btn btn-report">
                        <i class="fas fa-file-export"></i>
                        Générer rapport
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtres compacts -->
        <div class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                Filtres de période
            </div>
            <div class="row g-2">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Date de début</label>
                    <input max="@ViewBag.MaxDate" value="@ViewBag.StartDate" data-format="yyyy-MM-dd"
                           name="startDate" id="startDate" type="datetime-local"
                           class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Date de fin</label>
                    <input max="@ViewBag.MaxDate" value="@ViewBag.EndDate"
                           name="endDate" id="endDate" type="datetime-local"
                           class="form-control">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="btnFilter">
                        <i class="fas fa-check me-1"></i>Valider
                    </button>
                </div>
            </div>
        </div>

        <!-- Tableau compact -->
        <div class="table-container">
            <table class="table" id="tbCommandes">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Nom Complet</th>
                        <th scope="col">Montant</th>
                        <th scope="col">Paiement</th>
                        <th scope="col">Emplacement</th>
                        <th scope="col">Date</th>
                        <th scope="col">Statut</th>
                        <th scope="col">Détails</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>  

<div class="modal fade modal-lg" id="documentPartial">
</div>

@section Scripts{
@*    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
*@    
<!--BEGIN DATA EXCEL EXPORT-->
    <script src="~/jszip/jszip.min.js"></script>
    <script src="~/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="~/datatables-buttons/js/buttons.print.min.js"></script>
    <!--END DATA EXCEL EXPORT-->
    <script type="text/javascript">
        function loadData(dataRequest) {

            var successHandler = function (res) {
                //  console.log(JSON.stringify(res))
                if (res) {

                    if (res.success) {
                        try {
                            $('#tbCommandes').dataTable().fnDestroy();
                            $('#tbCommandes').DataTable().clear().draw();
                        }
                        catch {

                        }
                        var dataList = res.data;
                        if (dataList) {
                            const formatter = new Intl.NumberFormat("fr-FR");
                            var totalAmount = dataList.reduce((accumulator, currentValue) => {
                                if (currentValue.isDelivered == true && currentValue.isDeleted != true && currentValue.isRejected!=true) {
                                    return accumulator + currentValue.montant;
                                    }
                                  return accumulator;
                                }, 0);

                          $("#totalMontantVente").html(formatter.format(totalAmount)+" F CFA")

                }

                $.fn.dataTable.moment("DD/MM/YYYY HH:mm");
                var table = $('#tbCommandes').DataTable({
                    data: dataList,
                    responsive: true,
                    order: [[6, "desc"]],
                    destroy: true,
                            dom: 'Bfrtip',
                    text: 'Export',
                    buttons: [

                        {
                            extend: 'excelHtml5', titleAttr: 'Excel',
                                    text: '<span><i class="fa fa-file-excel-o"></i>&nbsp;Excel</span>',
                            exportOptions: {
                                columns: [":not('.js-not-exportable')"], orthogonal: 'export', rows: ":not('.ignorerow')"

                            },

                            filename: function () {
                                        var startDateString = "";
                                        var endDateString = "";
                                        var startDate = $("#startDate").val();
                                        var endDate = $("#endDate").val();
                                        if(startDate){
                                            startDateString = moment(startDate).format("DDMMYYYY HHmm");
                                        }
                                       if(endDate){
                                            endDateString = moment(endDate).format("DDMMYYYY HHmm");
                                       }
                                      
     
                                return 'Liste ' + "_" + startDateString+"_"+endDateString;
                            }
                        }

                    ],
                    columns: [
                        {
                            data: null,
                            width: '1%',
                            defaultContent: ''
                                    , className: "js-not-exportable"


                        },
                        {
                            data: "userNavigation",
                            width: '10%',
                            defaultContent: '',

                            render: function (data, type, row) {

                                if (data == null) {
                                    return "";
                                }
                                return `${data.login} `
                            }
                        },
                        {
                            width: '5%',
                            data: 'montant',
                            defaultContent: '',
                        }
                        ,
                        {

                            data: "paymentMethodNavigation",
                            width: '8%',
                            defaultContent: "",
                            render: function (data, type, row) {

                                if (data == null) {
                                    return "";
                                }
                                return data.name
                            }
                        },
                        {

                            data: "emplacementNavigation",
                            width: '10%',
                            defaultContent: "",
                            render: function (data, type, row) {

                                if (data == null) {
                                    return "";
                                }
                                return data.name
                            }
                        }
                        ,
                        {

                            data: "date",
                            width: '10%',
                            defaultContent: "",
                            render: function (data, type, row) {

                                if (data == null) {
                                    return "";
                                }
                                var date = moment(data).format("DD/MM/YYYY HH:mm");

                                return date;
                            }
                        }
                        ,

                        {

                            data: "isDelivered",
                            width: '15%',
                            defaultContent: "",
                            render: function (data, type, row, meta) {
                                var btnRateDetail = "";
                                        if (type === 'export') {
                                            if (row.isRejected == true) {
                                            return "rejetée";
                                            }
                                            if (row.isDeleted == true) {
                                                return "rejetée";
                                            }
                                            if (data == true) {
                                                return "livrée";
                                            }else{
                                                return "en attente";
                                            }
                                            
                                        }
                                if (row.isRating == true) {
                                    var checked5 = row.rate == 5 ? "checked" : "";
                                    var checked4 = row.rate == 4 ? "checked" : "";
                                    var checked3 = row.rate == 3 ? "checked" : "";
                                    var checked2 = row.rate == 2 ? "checked" : "";
                                    var checked1 = row.rate == 1 ? "checked" : "";
                                    var note = `<div class='rating' disabled style='max-width:100px;pointer-events: none !important'>
                                                    <input type='radio' name='rating${row.id}' ${checked5} value='5' id='5ll${row.id}'><label for='5ll${row.id}' style='font-size:1vw;'>☆</label>
                                                    <input type='radio' name='rating${row.id}' ${checked4} value='4' id='4ll${row.id}'><label for='4ll${row.id}' style='font-size:1vw;'>☆</label>
                                                    <input type='radio' name='rating${row.id}' ${checked3} value='3' id='3ll${row.id}'><label for='3ll${row.id}' style='font-size:1vw;'>☆</label>
                                                    <input type='radio' name='rating${row.id}' ${checked2} value='2' id='2ll${row.id}'><label for='2ll${row.id}' style='font-size:1vw;'>☆</label>
                                                    <input type='radio' name='rating${row.id}' ${checked1} value='1' id='1ll${row.id}'><label for='1ll${row.id}' style='font-size:1vw;'>☆</label>
                                                </div>`;
                                    btnRateDetail = `

                                                    <button type="button" data-method="GET"
                                                            data-modaltitle="Commentaire et note du client"
                                                                            data-modalbody="${note}<br>${row.customerFeedback}"
                                                            data-toggle="modal"
                                                            data-target="#genericModal" rel="tooltip"
                                                        class="btn btn-primary btn-sm m-2" data-original-title="" title="">
                                                    Avis du client
                                                        </button>
                                                                            `;
                                }

                                if (row.isRejected == true) {

                                    return `<span  class="badge badge-danger"> rejetée</span>

                                                                                    <button type="button" data-method="GET"
                                                                                        data-modaltitle="Motif du rejet"
                                                                                                data-modalbody="${row.rejectComment}"
                                                                                        data-toggle="modal"
                                                                                        data-target="#genericModal" rel="tooltip"
                                                                                    class="btn btn-primary btn-sm m-2" data-original-title="" title="">
                                                                                Motif
                                                                                     </button>
                                                            `;
                                }

                                if (data == true) {

                                    return `<span class="badge badge-success"> livrée</span>` + btnRateDetail;
                                }
                                var btnReject = "";
                                if (data != true) {
                                    if (row.userId != null && row.userId > 0) {
                                        btnReject = `
                                                <button type="button" data-method="POST"
                                                            data-modaltitle="Rejeter une commande"
                                                                            data-successhandler="rejetSuccessHandler"
                                                                    data-errorhandler="errorHandler"
                                                                    data-callback="updateStatusCell"
                                                                            data-forward="rejectFormValid()"
                                                                    data-getdata="getDataForm(${row.id})"
                                                                                                                data-modalbody="Motif du rejet<br><textarea class='form-control' name='motif' id='motif' ></textarea>"
                                                                        data-url="/Commande/Reject" data-toggle="modal"
                                                                data-target="#genericModal" rel="tooltip"
                                                                class="btn btn-danger btn-sm mx-2" data-original-title="" title="">
                                                    Rejeter
                                                </button>`;
                                    }

                                }

                                var btnDelivery = `<a class="btn btn-primary btn-sm float-end "
                                                                   data-method="POST"
                                                                   data-callback="DeliveryCallback"     
                                                                    data-message="Veuillez confirmer?"
                                                                    data-url="/Commande/Delivery/${row.id}" data-toggle="modal"
                                                                    data-target="#confirmModal"
                                                                 data-commandid="${row.id}"  href="#!">Livrer</a>
                                                                `

                                return `<div class="d-flex">${btnDelivery}  ${btnReject}  ${btnRateDetail}</div>` 
                                // return `<a class="btn btn-primary btn-sm float-end btnDelivery"  data-commandid="${row.id}"  href="#!">Livrer</a>`;


                            }


                        }
                        ,
                        {

                            data: "ligneCommandesNavigation",
                            width: '10%',
                            defaultContent: "",
                                    className: "dt-custom-control custom px-2 js-not-exportable",
                            render: function (data, type, row, meta) {
                                if (type === 'export') {

                                    return "";
                                }
                                return `<span class="dt-custom-control-plus"></span> <a> Détails</a> `;


                            }
                        }

                    ]
                    , "language": {
                        "zeroRecords": "Aucune donnée n'est disponible",
                        "lengthMenu": "Afficher _MENU_ éléments",
                        "info": "Affichage de l'élément _START_ à _END_ sur _TOTAL_ éléments",
                        "search": "Rechercher : ",
                        "oPaginate": {
                            "sFirst": "Premier",
                            "sLast": "Dernier",
                            "sNext": "Suivant",
                            "sPrevious": "Précédent"
                        },
                    }
                    ,
                    drawCallback: function (setting) {


                        $('[data-toggle="tooltip"]').tooltip();


                    },
                });

                function format(d) {
                    // `d` is the original data object for the row
                    if (!d.ligneCommandesNavigation) {

                        return;
                    }
                    var commentaire = d.comment;
                    commentaire = commentaire ? ` <div class="col-12 px-0 my-1 text-black text-center"><label class="mb-3 text-black fw-bold" style="font-size:11px;font-weight:bold">Commentaire: </label><p style="font-size:11px;" class="fw-bold ">${commentaire}</p></div>` : "";

                    let table = $(`<table cellpadding="5" class="childtable table table-bordered bg-gray" cellspacing="0" border="0" style="padding-left:50px;background-color:#c6dcf5;width:80%">
                                                                            <thead>

                                                                            <th scope="col" class="font-weight-bold text-left">Article</th>
                                                                            <th scope="col" class="font-weight-bold text-left">Quantité</th>
                                                                            <th scope="col" class="font-weight-bold text-left">Prix Total</th>

                                                                            </thead> </table>`);
                    table.DataTable({
                        data: d.ligneCommandesNavigation,
                        responsive: false,
                        destroy: true,
                        columns: [
                            {

                                data: "articleNavigation",
                                width: '10%',
                                defaultContent: "",
                                render: function (data, type, row) {
                                    return data ? data.title : "";
                                }
                            }, {

                                data: "quantite",
                                width: '10%',
                                defaultContent: "",

                            },
                            {

                                data: "prixTotal",
                                width: '10%',
                                defaultContent: "",

                            }

                        ]
                    });
                    var div = $(`<div class="" style="background-color:#c6dcf5;"></div>`)
                    div.append(commentaire)
                    div.append(table)
                    return div;
                }

                $('#tbCommandes tbody').on('click', ".btnDelivery", function () {

                    var commandId = $(this).data("commandid");
                    if (!commandId || commandId <= 0) return;
                    var successHandler = (response) => {
                        if (response) {
                            if (response.success) {


                                $(this).replaceWith(`<span class="badge badge-success"> livré</span>`);


                            }
                        }
                    }
                    ajaxManager("POST", "/Commande/Delivery", successHandler, errorHandler, { id: commandId });
                });


                $('#tbCommandes tbody').on('click', '.dt-custom-control.custom', function () {

                    try {



                        var tr = $(this).closest('tr');
                        var trChild = $(this).closest('tr.child');

                        var hasSecondChild = false;
                        var row;
                        if (trChild.length > 0) {
                            //console.log("trChild ", trChild)
                            //trChild = $(this).closest('tr.child');
                            var tr = $(trChild[0]).prev('tr.dt-hasChild.parent');
                            hasSecondChild = true;
                            row = table.row(tr);
                        } else {
                            row = table.row(tr);

                        }

                        console.log("row = ", row)
                        var rowData = row.data();
                        if (row != undefined && row != null) {

                            if (!hasSecondChild) {
                                if (row.child.isShown()) {
                                    // This row is already open - close it
                                    row.child.hide();
                                    tr.removeClass('dt-hasChild shown');
                                    $(this).find('span.dt-custom-control-plus').removeClass("haschild");
                                }
                                else {
                                    $(this).find('span.dt-custom-control-plus').addClass("haschild");


                                    // Open this row

                                    row.child(format(rowData)).show();
                                    tr.addClass('dt-hasChild shown');
                                }
                            } else {

                                if (trChild.hasClass("second-child")) {
                                    trChild.find("table").remove();
                                    trChild.removeClass("second-child")
                                } else {
                                    console.log("append", rowData)
                                    trChild.find("td.child").append(format(rowData));
                                    trChild.addClass("second-child")
                                }
                            }


                        }






                    } catch (e) {
                        console.log(e)
                    }




                });

            } else {

                ToastR(res.message, res.status, 15);
        }
                                }



                            }



        var errorHandler = (err) => {
            try {
                $('#tbCommandes').dataTable().fnDestroy();
                $('#tbCommandes').DataTable().clear().draw();
            }
            catch {

            }
            ToastR("Une erreur a été rencontré", "error", 15);
        }


        ajaxManager('GET', '/Commande/GetAllCommandes', successHandler, errorHandler, dataRequest);
                        }

        $(function () {

            loadData();


            $("#btnFilter").off().on("click",
                function () {

                    var startDate = $("#startDate").val();

                    var endDate = $("#endDate").val();

                    if (!startDate) {
                        ToastR("Veuillez indiquer la date de début", "error", 5);
                        return;
                    }
                    if (!endDate) {
                        ToastR("Veuillez indiquer la date de fin", "error", 5);
                        return;
                    }
                    startDate = moment(startDate);
                    endDate = moment(endDate);
                    var dateDiff = monthDiff(startDate, endDate);
                    if (dateDiff < 0) {
                        ToastR("La date de fin doit être supérieure à la date de début.", "error", 5);
                        return;
                    }

                    if (dateDiff > 3) {
                        ToastR("La différence entre la date de fin et la date de début doit être inférieure ou égale à 3 mois.", "error", 5);
                        return;
                    }


                    var data = {

                        startDate: $("#startDate").val(),
                        endDate: $("#endDate").val()
                    }
                    console.log(data)
                    loadData(data);

                }

            );


        });


        function DeliveryCallback(btn, data) {



            $(btn).replaceWith(`<span class="badge badge-success"> livrée</span>`);

        }
        function getDataForm(id) {

            var formData = new FormData();
            formData.append("motif", $("#genericModal").find("#motif").val());
            formData.append("commandId", id);


            return formData;

        }
        function updateStatusCell(btn, data) {

            var td = $(btn).closest('td');

            console.log("td = ", td)
            console.log("data = ", data);
            if (data) {
                td.html(`<span class="badge badge-danger">rejetée</span>`);
                //  td.html(`${data.solde} F CFA`);
            }

        }

        function rejectFormValid() {

            var val = $("#genericModal").find("#motif").val();

            if (!val) {

                ToastR("Veuillez renseigner le motif du rejet!", "error", 10);
                return "return";
            }
        }

        var rejetSuccessHandler = (res) => {
            if (res) {
                let status = res.success ? "success" : "error"
                ToastR(res.message, status, 15);
            }

        }
    </script>
            }