@inject IHttpContextAccessor Accessor;
@{
    bool isGerant = Convert.ToBoolean(Accessor.HttpContext?.Session.GetString("IsGerant") ?? "false");
}
@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body{
            background-color:white;
        }
        /* STYLES DES COMMANDES - CONSERVÉS INTACTS */
        .command-card {
            background: #ffffff;
            border: 1px solid #e3f2fd;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 16px;
            overflow: hidden;
        }

            .command-card:hover {
                box-shadow: 0 4px 20px rgba(0,0,0,0.12);
                transform: translateY(-2px);
            }

        .card-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 12px 16px;
            border-bottom: none;
            text-align: center;
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-icon {
            font-size: 14px;
        }

        .customer-name {
            font-weight: 600;
            font-size: 16px;
        }

        .card-body {
            padding: 16px;
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .location-icon {
            color: #ff6b6b;
            font-size: 14px;
        }

        .payment-method {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }

        .payment-icon {
            font-size: 12px;
        }

        .command-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .timer-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .distance-badge {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .deliver-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

            .deliver-btn:hover {
                background: linear-gradient(135deg, #45a049, #3d8b40);
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
                color: white;
                text-decoration: none;
            }

        .articles-section {
            margin: 12px 0;
        }

        .articles-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
        }

        .article-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid #e9ecef;
        }

            .article-item:last-child {
                border-bottom: none;
            }

        .article-name {
            font-size: 13px;
            color: #495057;
            flex: 1;
        }

        .article-quantity {
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .comment-section {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 8px 12px;
            margin-top: 12px;
            border-radius: 4px;
        }

        .comment-label {
            font-weight: 600;
            color: #e65100;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .comment-icon {
            font-size: 12px;
        }

        .comment-text {
            font-size: 12px;
            color: #e65100;
            margin: 0;
            line-height: 1.4;
        }

        /* FILTRES ENTREPRISES ET EMPLACEMENTS */
        .filters-container {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .filter-section {
            margin-bottom: 20px;
        }

            .filter-section:last-child {
                margin-bottom: 0;
            }

        .filter-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters_menu {
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            list-style-type: none;
            margin: 0;
            gap: 8px;
        }

            .filters_menu li {
                padding: 10px 20px;
                cursor: pointer;
                border-radius: 25px;
                background: #ffffff;
                border: 2px solid #e9ecef;
                color: #6c757d;
                font-weight: 600;
                transition: all 0.3s ease;
                font-size: 14px;
            }

                .filters_menu li.active {
                    background: linear-gradient(135deg, #FF6B35 0%, #00C9B1 100%);
                    color: #ffffff;
                    border-color: transparent;
                    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
                }

                .filters_menu li:hover:not(.active) {
                    border-color: #FF6B35;
                    color: #FF6B35;
                    transform: translateY(-2px);
                }

        .emplacements-section {
            display: none;
        }

            .emplacements-section.active {
                display: block;
            }

        /* NOUVEAU DESIGN UNIQUEMENT POUR LES EMPLACEMENTS - MÊME STRUCTURE */
        .food_section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 40px 0;
        }

        .heading_container h2 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Barre de recherche moderne */
        .col-md-6 {
            max-width: 500px;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 50px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

            .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
            }

        /* Message aucune commande */
        #noItemsAlert {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            color: #6c757d;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .heading_container h2 {
                font-size: 2rem;
            }

            .filters_menu li {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .form-control {
                padding: 10px 16px;
            }

            .filters-container {
                padding: 15px;
            }
        }
    </style>
}

<!-- STRUCTURE HTML AVEC FILTRES ENTREPRISES ET EMPLACEMENTS -->
<section class="food_section ">
    <div class="container" style="width:100%;margin-left:0;margin-right:0;max-width:100%;">
        <div class="heading_container">
            <h2>
                Liste des commandes en attente
            </h2>
        </div>

        <!-- Section des filtres -->
        <div class="filters-container">
            <!-- Filtre par entreprise -->
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-building"></i>
                    Entreprises
                </div>
                <ul id="entreprisesFilterList" class="filters_menu">
                    <li class="active" data-entreprise-id="0">Toutes les entreprises</li>
                </ul>
            </div>

            <!-- Filtre par emplacement -->
            <div id="emplacementsSection" class="filter-section emplacements-section">
                <div class="filter-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Emplacements
                </div>
                <ul id="emplacementsFilterList" class="filters_menu">
                    <li class="active" data-emplacement-id="0">Tous les emplacements</li>
                </ul>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="d-flex justify-content-center">
            <div class="col-md-6">
                <label class="form-label">Rechercher par client</label>
                <input type="text" class="form-control" placeholder="" id="searchText" />
            </div>
        </div>

        <!-- Message aucune commande -->
        <div class="d-flex justify-content-center">
            <div class="center my-3 justify-content-center align-self-center" id="noItemsAlert" style="display:none">
                Aucune commande en attente n'est disponible
            </div>
        </div>

        <!-- Liste des commandes -->
        <div class="row">
            <div class="col-md-12 filters-content">
                <div class="col-md-12 row grid" id="messagesList" style="padding:20px;">
                    <!-- Les commandes seront ajoutées dynamiquement ici -->
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Modal de confirmation livraison -->
<div class="modal fade" id="deliverModal" tabindex="-1" aria-labelledby="deliverModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliverModalLabel">Confirmer la livraison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir livrer cette commande ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirmDeliverBtn">Livrer</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        var selectedEntrepriseId = 0;
        var selectedEmplacementId = 0;
        var currentCommandId = 0; // Commande à livrer

        $(function(){
            // --- Recherche par client ---
            $("#searchText").on("input", function () {
                var value = $(this).val().toLowerCase();
                $(".grid").isotope({
                    filter: function () {
                        var fullname = $(this).find('.fullname').text().toLowerCase();
                        return fullname.includes(value);
                    }
                });
            });

            var errorHandler = (err) => {
                ToastR("Une erreur a été rencontrée", "error", 15);
            }

            // --- Chargement entreprises ---
            var successEntreprisesHandler = function (res) {
                if (res && res.success && res.data) {
                    res.data.forEach((entreprise) => {
                        var nom = entreprise.nom ? entreprise.nom.toUpperCase() : "NOM INCONNU";
                        $("#entreprisesFilterList").append(
                            `<li data-entreprise-id="${entreprise.id}">${nom}</li>`
                        );
                    });

                    // Click sur entreprise
                    $('#entreprisesFilterList li').off("click").on("click", function () {
                        $('#entreprisesFilterList li').removeClass('active');
                        $(this).addClass('active');

                        selectedEntrepriseId = $(this).data('entreprise-id');

                        if (selectedEntrepriseId > 0) {
                            loadEmplacementsByEntreprise(selectedEntrepriseId);
                            $('#emplacementsSection').addClass('active');
                        } else {
                            $('#emplacementsSection').removeClass('active');
                            selectedEmplacementId = 0;
                            GetPendingCommandes();
                        }
                    });
                }
            }

            function loadEmplacementsByEntreprise(entrepriseId) {
                var successEmplacementsHandler = function (res) {
                    if (res && res.success && res.data) {
                        $("#emplacementsFilterList").html('<li class="active" data-emplacement-id="0">Tous les emplacements</li>');
                        res.data.forEach((emplacement) => {
                            if (emplacement.actif) {
                                $("#emplacementsFilterList").append(
                                    `<li data-emplacement-id="${emplacement.id}">${emplacement.name.toUpperCase()}</li>`
                                );
                            }
                        });

                        $('#emplacementsFilterList li').off("click").on("click", function () {
                            $('#emplacementsFilterList li').removeClass('active');
                            $(this).addClass('active');

                            selectedEmplacementId = $(this).data('emplacement-id');
                            GetPendingCommandes();
                        });

                        // Charger commandes après les emplacements
                        GetPendingCommandes();
                    }
                }

                ajaxManager('GET', `/Emplacement/GetEmplacementsByEntreprise?entrepriseId=${entrepriseId}`, successEmplacementsHandler, errorHandler);
            }

            // --- Récupération commandes ---
            function GetPendingCommandes() {
                var url = '/Commande/GetPendingCommandesV2';
                var params = [];

                if (selectedEntrepriseId > 0) params.push(`entrepriseId=${selectedEntrepriseId}`);
                if (selectedEmplacementId > 0) params.push(`emplacementId=${selectedEmplacementId}`);
                if (params.length > 0) url += '?' + params.join('&');

                ajaxManager('GET', url, function(res){
                    if(res && res.success) displayCommandes(res.data);
                }, errorHandler);
            }

            // --- Affichage commandes ---
            function displayCommandes(commandes) {
                $("#messagesList").html("");
                if (!commandes || commandes.length === 0) {
                    $("#noItemsAlert").show();
                    return;
                }
                $("#noItemsAlert").hide();

                commandes.forEach((command) => {
                    var fullname = command.userNavigation ? command.userNavigation.login : "";
                    var emplacement = command.emplacementNavigation ? command.emplacementNavigation.name : "";
                    var paymentMethod = command.paymentMethodNavigation ? command.paymentMethodNavigation.name : "";
                    var emplacementId = command.emplacementNavigation ? command.emplacementNavigation.id : 0;
                    var entrepriseId = command.emplacementNavigation && command.emplacementNavigation.entreprise ?
                                       command.emplacementNavigation.entreprise.id : 0;

                    paymentMethod = paymentMethod == "SOLDE" ? "DOTATION" : paymentMethod;
                    var paymentMethodHtml = paymentMethod ? `
                        <div class="payment-method">
                            <i class="fas fa-credit-card payment-icon"></i>
                            <span class="payment-text">${paymentMethod}</span>
                        </div>` : '';

                    var commandeADistance = command.commandeADistance ? `
                        <span class="distance-badge">
                            <i class="fas fa-truck"></i>
                            À distance
                        </span>` : '';

                    var commentaire = command.comment;
                    var commentaireHtml = commentaire ? `
                        <div class="comment-section">
                            <div class="comment-label">
                                <i class="fas fa-comment comment-icon"></i>
                                Commentaire:
                            </div>
                            <p class="comment-text">${commentaire}</p>
                        </div>` : "";

                    $("#messagesList").append(`
                         <div class="command-card col-md-4 mx-2 col-lg-4 col-xl-3 all entreprise_${entrepriseId} emplacement_${emplacementId}" id="command_${command.id}">
                            <div class="card-header">
                                <div class="customer-info">
                                    <i class="fas fa-user customer-icon"></i>
                                    <span class="customer-name fullname">${fullname}</span>
                                </div>
                            </div>

                            <div class="card-body">
                                <div class="location-info">
                                    <i class="fas fa-map-marker-alt location-icon"></i>
                                    <span class="location-text">${emplacement}</span>
                                </div>

                                ${paymentMethodHtml}

                                <div class="command-actions">
                                    <div class="timer-badge" id="time${command.id}"></div>
                                    ${commandeADistance}
                                    <a class="deliver-btn" data-commandid="${command.id}" href="#!">
                                        <i class="fas fa-check deliver-icon"></i>
                                        Livrer
                                    </a>
                                </div>

                                <div class="articles-section">
                                    <div id='lignesCommande${command.id}' class="articles-list"></div>
                                </div>

                                ${commentaireHtml}
                            </div>
                        </div>
                    `);

                    if (command.ligneCommandesNavigation) {
                        command.ligneCommandesNavigation.forEach((ligne) => {
                            $(`#lignesCommande${command.id}`).append(`
                                <div class="article-item" id="row_${ligne.articleNavigation.id}">
                                    <span class="article-name">${ligne.articleNavigation.title}</span>
                                    <span class="article-quantity">${ligne.quantite}</span>
                                </div>
                            `);
                        });
                    }
                });

                initializeIsotope();
                clearInterval(window.setTimers);
                window.setTimers = setInterval(setTimers, 1000, commandes);
            }

            function initializeIsotope() {
                try {
                    var itemReveal = Isotope.Item.prototype.reveal;
                    Isotope.Item.prototype.reveal = function () {
                        itemReveal.apply(this, arguments);
                        $(this.element).removeClass('isotope-hidden');
                    };
                    var itemHide = Isotope.Item.prototype.hide;
                    Isotope.Item.prototype.hide = function () {
                        itemHide.apply(this, arguments);
                        $(this.element).addClass('isotope-hidden');
                    };
                } catch { }

                var $grid = $(".grid").isotope({
                    itemSelector: ".all",
                    percentPosition: false,
                    masonry: { columnWidth: ".all" }
                });

                $grid.isotope('on', 'layoutComplete', function () {
                    var numItems = $grid.find('.all:not(.isotope-hidden)').length;
                    if (numItems == 0) $("#noItemsAlert").show();
                    else $("#noItemsAlert").hide();
                });

                return $grid;
            }

            // --- Livraison commandes via MODAL ---
            $(document).on('click', '.deliver-btn', function(e) {
                e.preventDefault();
                currentCommandId = $(this).data('commandid');
                var modal = new bootstrap.Modal(document.getElementById('deliverModal'));
                modal.show();
            });

            $('#confirmDeliverBtn').on('click', function() {
                $.ajax({
                    type: 'POST',
                    url: `/Commande/Delivery/${currentCommandId}`,
                    success: function(res) {
                        if(res && res.success) {
                            DeleteCommandItem(currentCommandId);
                            var modalEl = document.getElementById('deliverModal');
                            var modal = bootstrap.Modal.getInstance(modalEl);
                            modal.hide();
                            ToastR("Commande livrée avec succès", "success", 10);

                        } else {
                            ToastR("Erreur lors de la livraison,veuillez reessayer", "error", 10); 
                        }
                    },
                    error: function() {
                        alert("Erreur serveur, veuillez réessayer");
                    }
                });
            });

            // --- Supprimer commande du DOM ---
            function DeleteCommandItem(commandId) {
                $(`#command_${commandId}`).remove();
                var $grid = $(".grid").isotope();
                $grid.isotope('layout');

                if($grid.find('.all:not(.isotope-hidden)').length === 0)
                    $("#noItemsAlert").show();
            }

            // --- Chargement initial ---
            ajaxManager('GET', '/Entreprise/GetEntreprises', successEntreprisesHandler, errorHandler);
        });
    </script>
}

